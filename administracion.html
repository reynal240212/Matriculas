<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci贸n - GORA PRSTAMOS</title> <!-- CAMBIO DE MARCA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo_agora.png') }}">
    <!-- (Estilos en l铆nea que ya ten铆as para la personalizaci贸n de la p谩gina de admin) -->
</head>
<body class="bg-dark text-light">
    <!-- ... (tu bloque de mensajes flash) ... -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <!-- CAMBIO DE MARCA -->
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('administracion') }}">
                <img src="{{ url_for('static', filename='loginFormLogo.png') }}" alt="Logo gora Pr茅stamos" height="40" class="me-2" />
                <span class="fw-bold">Panel de Administrador</span>
            </a>
            <div>
              <a href="{{ url_for('index') }}" class="btn btn-outline-info me-2">Ver Sitio P煤blico</a>
              <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Cerrar Sesi贸n</a>
            </div>
        </div>
    </nav>
    <!-- ... (resto de tu contenido de administraci贸n.html) ... -->
     <div class="container mt-5 pt-4"> 
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">

        <h2 class="fw-bold text-light">Gesti贸n de Clientes</h2>

        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#crearUsuarioModal">
                <i class="bi bi-person-plus-fill"></i> Crear Cliente
            </button>

            <a href="{{ url_for('administracion', filtro='mostrar_todo', valor='') }}" class="btn btn-info text-white">
                <i class="bi bi-people-fill"></i> Mostrar Todos
            </a>
            
            <a href="{{ url_for('verificar_vencimientos') }}" class="btn btn-danger text-white">
                <i class="bi bi-arrow-clockwise"></i> Recargar Estados
            </a>

            <a href="{{ url_for('ver_todas_compras') }}" class="btn btn-primary text-white">
                <i class="bi bi-receipt-cutoff"></i> Ver Compras
            </a>
        </div>
    </div>

        <div class="card bg-secondary text-light mb-4 shadow-lg">
            <div class="card-body">
                <form method="GET" action="{{ url_for('administracion') }}" class="input-group">
                    <span class="input-group-text bg-dark text-white fw-bold">Buscar por:</span>

                    <select name="filtro" class="form-select bg-dark text-light" required>
                        <option value="" disabled selected>Seleccione</option>
                        <option value="id">ID</option>
                        <option value="nombre">Nombre</option>
                        <option value="apellidos">Apellidos</option>
                        <option value="cedula">C茅dula</option>
                        <option value="genero">G茅nero</option>
                        <option value="numero">Tel茅fono</option>
                        <option value="direccion">Direcci贸n</option>
                        <option value="correo">Correo</option>
                        <option value="estado">Estado</option>
                    </select>

                    <input type="text" name="valor" class="form-control bg-dark text-light" placeholder="Escribe aqu铆..." required>

                    <button type="submit" class="btn btn-primary fw-bold"><i class="bi bi-search"></i> Buscar</button>
                </form>
            </div>
        </div>
        {% if not request.args.get('filtro') and not usuarios %}
        <div class="alert alert-info text-center" role="alert">
            Por favor, usa la barra de b煤squeda para cargar y filtrar usuarios, o haz clic en "Mostrar Todos".
        </div>
        {% elif request.args.get('filtro') and not usuarios %}
        <div class="alert alert-warning text-center" role="alert">
            No se encontraron usuarios que coincidan con la b煤squeda.
        </div>
        {% endif %}

        {% if usuarios %}
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle text-center shadow">
                <thead class="table-secondary">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Apellidos</th>
                        <th>C茅dula</th>
                        <th>Tel茅fono</th>
                        <th>Correo</th>
                        <th>Estado</th>
                        <th>Expira</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaUsuarios">
                    {% for usuario in usuarios %}
                    <tr>
                        <td>{{ usuario.id }}</td>
                        <td>{{ usuario.nombre }}</td>
                        <td>{{ usuario.apellidos }}</td>
                        <td>{{ usuario.cedula }}</td>
                        <td>{{ usuario.numero }}</td>
                        <td>{{ usuario.correo }}</td>
                        <td>
                            {% if usuario.estado_actual == 'Activo' %}
                            <span class="badge bg-success">Activo</span>
                            {% else %}
                            <span class="badge bg-danger">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-warning text-dark">{{ usuario.expiracion_str }}</span>
                        </td>
                        <td>
                            <button class="btn btn-warning btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#editarUsuarioModal"
                                data-id="{{ usuario.id }}">
                                <i class="bi bi-pencil-fill"></i> Editar
                            </button>
                            
                            <button type="button" 
                                class="btn btn-sm btn-success text-white mb-1"
                                data-bs-toggle="modal"
                                data-bs-target="#registrarCompraModal"
                                data-id="{{ usuario.id }}"
                                data-nombre="{{ usuario.nombre }} {{ usuario.apellidos }}">
                                <i class="bi bi-cart-plus-fill"></i> Compra
                            </button>

                            <button type="button" 
                            class="btn btn-sm {% if usuario.estado_actual == 'Activo' %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
                            data-bs-toggle="modal"
                            data-bs-target="#activacionModal"
                            data-id="{{ usuario.id }}"
                            data-accion="{% if usuario.estado_actual == 'Activo' %}inactivar{% else %}activar{% endif %}"
                            data-nombre="{{ usuario.nombre }}">
                                {% if usuario.estado_actual == 'Activo' %}
                                <i class="bi bi-toggle-off"></i> Inactivar
                                {% else %}
                                <i class="bi bi-toggle-on"></i> Activar
                                {% endif %}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <div class="modal fade" id="crearUsuarioModal" tabindex="-1" aria-labelledby="crearUsuarioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content text-dark bg-light">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">Crear nuevo usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('agregar_usuario') }}">
                        <div class="mb-2"><input type="text" name="nombre" class="form-control" placeholder="Nombre" required></div>
                        <div class="mb-2"><input type="text" name="apellidos" class="form-control" placeholder="Apellidos" required></div>
                        <div class="mb-2"><input type="text" name="cedula" class="form-control" placeholder="C茅dula" required></div>
                        <div class="mb-2"><input type="text" name="nacionalidad" class="form-control" placeholder="Nacionalidad" required></div>
                        <div class="mb-2">
            
                                <select name="trabaja" id="trabaja" class="form-control" required>
                                    <option value="">驴Trabajas actualmente?...</option>
                                    <option value="si">S铆</option>
                                    <option value="no">No</option>
                                </select>
                       </div>
                       <div id="datos_empresa" style="display:none;">
                            <div class="mb-2"><input type="text" name="empresa_nombre" class="form-control" placeholder="Nombre de la empresa"></div>
                            <div class="mb-2"><input type="text" name="empresa_direccion" class="form-control" placeholder="Direcci贸n de la empresa"></div>
                            <div class="mb-2"><input type="text" name="empresa_telefono" class="form-control" placeholder="Tel茅fono de la empresa"></div>
                            <div class="mb-2"><input type="email" name="empresa_correo" class="form-control" placeholder="Correo de la empresa"></div>
                            <div class="mb-2"><input type="number" name="empresa_salario" class="form-control" placeholder="Salario mensual"></div>
                        </div>

                        <div class="mb-2"><input type="text" name="genero" class="form-control" placeholder="G茅nero" required></div>
                        <div class="mb-2"><input type="text" name="numero" class="form-control" placeholder="Tel茅fono" required></div>
                        <div class="mb-2"><input type="text" name="direccion" class="form-control" placeholder="Direcci贸n" required></div>
                        <div class="mb-2"><input type="email" name="correo" class="form-control" placeholder="Correo" required></div>
                        <div class="mb-2"><input type="password" name="password" class="form-control" placeholder="Contrase帽a (M铆n. 6 caracteres)" required></div>
                        <button type="submit" class="btn btn-success w-100 fw-bold mt-3">Guardar Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-labelledby="editarUsuarioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content text-dark bg-light">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">Editar usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditar" method="POST">
                        <input type="hidden" id="edit-id" name="id">
                        <div class="mb-2"><input type="text" id="edit-nombre" name="nombre" class="form-control" placeholder="Nombre" required></div>
                        <div class="mb-2"><input type="text" id="edit-apellidos" name="apellidos" class="form-control" placeholder="Apellidos" required></div>
                        <div class="mb-2"><input type="text" id="edit-cedula" name="cedula" class="form-control" placeholder="C茅dula" required></div>
                        <div class="mb-2"><input type="text" id="edit-nacionalidad" name="nacionalidad" class="form-control" placeholder="Nacionalidad" required></div>
                        <div class="mb-2"><input type="text" id="edit-genero" name="genero" class="form-control" placeholder="G茅nero" required></div>
                        <div class="mb-2"><input type="text" id="edit-numero" name="numero" class="form-control" placeholder="Tel茅fono" required></div>
                        <div class="mb-2"><input type="text" id="edit-direccion" name="direccion" class="form-control" placeholder="Direcci贸n" required></div>
                        <div class="mb-2"><input type="email" id="edit-correo" name="correo" class="form-control" placeholder="Correo" required></div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold mt-3">Actualizar Informaci贸n</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="activacionModal" tabindex="-1" aria-labelledby="activacionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content text-dark bg-light">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold" id="activacionModalLabel">Control de Activaci贸n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formActivacion" method="POST">
                    <div class="modal-body">
                        <p id="mensajeModal"></p>
                        
                        <input type="hidden" name="accion" id="inputAccion">
                        
                        <div id="duracionContainer" class="mb-3">
                            <label for="inputDuracion" class="form-label fw-bold">Duraci贸n de la activaci贸n (en d铆as):</label>
                            <input type="number" name="duracion_dias" id="inputDuracion" class="form-control" 
                                value="30" min="0" placeholder="0 para permanente">
                            <div class="form-text">Ingresa <code class="text-dark">0</code> para una activaci贸n **permanente**.</div>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnConfirmar" class="btn btn-primary fw-bold">Confirmar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registrarCompraModal" tabindex="-1" aria-labelledby="registrarCompraModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content text-dark bg-light">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold" id="registrarCompraModalLabel">Registrar Compra para <span id="nombreUsuarioRegistrar"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formRegistrarCompra" method="POST">
                    <div class="modal-body">
                        <p class="lead">Ingresa los datos de la cuenta de streaming asignada al cliente.</p>
                        
                        <div class="mb-3">
                            <label for="plataforma" class="form-label fw-bold">Plataforma/Servicio:</label>
                            <input type="text" name="plataforma" class="form-control" placeholder="Ej: Netflix Premium (Pantalla 2)" required>
                        </div>

                        <div class="mb-3">
                            <label for="fecha_compra" class="form-label fw-bold">Fecha de Compra (Inicio del Servicio):</label>
                            <input type="date" name="fecha_compra" id="fecha_compra" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duracion_dias_compra" class="form-label fw-bold">Duraci贸n (d铆as):</label>
                            <input type="number" name="duracion_dias" id="duracion_dias_compra" class="form-control" value="30" min="1" required>
                            <div class="form-text">La compra vencer谩 contando desde la fecha de compra.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fecha_vencimiento_display" class="form-label fw-bold">Fecha de Vencimiento (Calculada):</label>
                            <input type="text" id="fecha_vencimiento_display" class="form-control bg-light" readonly>
                        </div>
                        <hr>
                        <p class="fw-bold">Credenciales de la Cuenta de Streaming:</p>

                        <div class="mb-3">
                            <input type="email" name="correo_cuenta" class="form-control" placeholder="Correo de la cuenta" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" name="contrasena_cuenta" class="form-control" placeholder="Contrase帽a de la cuenta" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" name="perfil_pin" class="form-control" placeholder="Perfil y PIN asignado (Ej: PERFIL 2 / PIN 2020)">
                            <div class="form-text">Informaci贸n clave que enviaste al cliente.</div>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success fw-bold">Registrar Compra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.getElementById("trabaja").addEventListener("change", function () {
            let valor = this.value;
            let datosEmpresa = document.getElementById("datos_empresa");

            if (valor === "si") {
                datosEmpresa.style.display = "block";
            } else {
                datosEmpresa.style.display = "none";
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            //  L贸gica para calcular y mostrar la fecha de vencimiento en el modal de Compra
            function calcularFechaVencimiento() {
                // Obtiene los campos del modal de COMPRA
                const fechaCompraInput = document.getElementById('fecha_compra');
                const duracionInput = document.getElementById('duracion_dias_compra'); // Usar el ID corregido
                const vencimientoDisplay = document.getElementById('fecha_vencimiento_display');

                const fechaCompraStr = fechaCompraInput.value;
                const duracionDias = parseInt(duracionInput.value);

                if (fechaCompraStr && !isNaN(duracionDias) && duracionDias >= 1) {
                    const parts = fechaCompraStr.split('-');
                    // Crea una nueva fecha, ajustando el mes (0-indexado) y forzando el huso horario para evitar errores de fecha
                    const fechaCompra = new Date(parts[0], parts[1] - 1, parts[2]); 
                    
                    const fechaVencimiento = new Date(fechaCompra);
                    // Suma la duraci贸n en d铆as
                    fechaVencimiento.setDate(fechaVencimiento.getDate() + duracionDias);
                    
                    // Formato YYYY-MM-DD
                    const year = fechaVencimiento.getFullYear();
                    const month = String(fechaVencimiento.getMonth() + 1).padStart(2, '0');
                    const day = String(fechaVencimiento.getDate()).padStart(2, '0');
                    
                    vencimientoDisplay.value = `${year}-${month}-${day}`;
                } else {
                    vencimientoDisplay.value = 'Ingresa Fecha y Duraci贸n';
                }
            }
            
            // 1. Escuchar cambios en los campos del modal de Compra para recalcular
            const fechaCompraInput = document.getElementById('fecha_compra');
            const duracionInputCompra = document.getElementById('duracion_dias_compra');
            
            if (fechaCompraInput && duracionInputCompra) {
                fechaCompraInput.addEventListener('change', calcularFechaVencimiento);
                duracionInputCompra.addEventListener('input', calcularFechaVencimiento);
            }
            // Fin de la l贸gica de c谩lculo

            // 锔 L贸gica para rellenar modal de edici贸n
            const editarUsuarioModal = document.getElementById('editarUsuarioModal');
            editarUsuarioModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const userId = button.getAttribute('data-id');

                const fila = button.closest('tr');
                const celdas = fila.querySelectorAll('td');

                document.getElementById('edit-id').value = celdas[0].textContent.trim();
                document.getElementById('edit-nombre').value = celdas[1].textContent.trim();
                document.getElementById('edit-apellidos').value = celdas[2].textContent.trim();
                document.getElementById('edit-cedula').value = celdas[3].textContent.trim();
                
                // 锔 Se asume que en el HTML original la tabla tiene 9 columnas antes de Acciones
                // (ID, Nombre, Apellidos, C茅dula, Tel茅fono, Correo, Estado, Expira).
                // Ajusta los 铆ndices de celdas seg煤n los datos que necesites de las filas
                // Tel茅fono es celdas[4]
                document.getElementById('edit-numero').value = celdas[4].textContent.trim(); 
                // Correo es celdas[5]
                document.getElementById('edit-correo').value = celdas[5].textContent.trim();

                // Para campos que no est谩n visibles en la tabla como 'genero' y 'direccion', 
                // necesitar铆as cargar el usuario completo mediante una petici贸n AJAX o 
                // almacenar esos datos en atributos 'data-...' en la fila.
                // Por ahora, solo actualizamos los campos de la tabla:
                document.getElementById('edit-genero').value = ''; // No disponible en la tabla
                document.getElementById('edit-direccion').value = ''; // No disponible en la tabla

                document.getElementById('formEditar').action = `/editar_usuario/${userId}`;
            });


            //  L贸gica para rellenar modal de Activaci贸n/Inactivaci贸n
            const activacionModal = document.getElementById('activacionModal');
            activacionModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const userId = button.getAttribute('data-id');
                const accion = button.getAttribute('data-accion');
                const userName = button.getAttribute('data-nombre');

                const formActivacion = document.getElementById('formActivacion');
                const inputAccion = document.getElementById('inputAccion');
                const duracionContainer = document.getElementById('duracionContainer');
                const mensajeModal = document.getElementById('mensajeModal');
                const btnConfirmar = document.getElementById('btnConfirmar');
                const inputDuracion = document.getElementById('inputDuracion');

                formActivacion.action = `/inactivar_usuario/${userId}`;
                inputAccion.value = accion;

                if (accion === 'activar') {
                    mensajeModal.innerHTML = `Est谩s a punto de **ACTIVAR** la cuenta de **${userName}**. Ingresa la duraci贸n.`;
                    duracionContainer.style.display = 'block';
                    inputDuracion.setAttribute('required', 'required');
                    btnConfirmar.textContent = 'Activar';
                    btnConfirmar.className = 'btn btn-success fw-bold';
                } else {
                    mensajeModal.innerHTML = `驴Est谩s seguro de **INACTIVAR** la cuenta de **${userName}**? La duraci贸n de activaci贸n se reiniciar谩.`;
                    duracionContainer.style.display = 'none';
                    inputDuracion.removeAttribute('required');
                    btnConfirmar.textContent = 'Inactivar';
                    btnConfirmar.className = 'btn btn-danger fw-bold';
                }
            });
            
            //  L贸gica para rellenar modal de Registro de Compra (Incluye c谩lculo de fecha)
            const registrarCompraModal = document.getElementById('registrarCompraModal');
            registrarCompraModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const userId = button.getAttribute('data-id');
                const userName = button.getAttribute('data-nombre');

                const formRegistrarCompra = document.getElementById('formRegistrarCompra');
                const nombreUsuarioRegistrar = document.getElementById('nombreUsuarioRegistrar');

                formRegistrarCompra.action = `/registrar_compra/${userId}`;
                nombreUsuarioRegistrar.textContent = userName;
                
                // Reiniciar el formulario
                formRegistrarCompra.reset(); 
                
                // Poner la fecha actual por defecto y calcular el vencimiento
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fecha_compra').value = today;
                
                // Establecer la duraci贸n por defecto a 30 d铆as
                document.getElementById('duracion_dias_compra').value = 30;
                
                calcularFechaVencimiento(); // Calcular el vencimiento inicial
            });

        });
    </script>
</body>
</html>